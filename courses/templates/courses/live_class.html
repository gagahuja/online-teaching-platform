{% extends "courses/base.html" %}

{% block content %}

<div class="container-fluid p-0">

<div class="bg-dark text-white p-2 d-flex justify-content-between">

<span>
Class: {{ session.title }}
</span>

<span>
User: {{ request.user.username }} ({{ user_role }})
</span>

</div>

<div id="jitsi-container" style="height:92vh;"></div>

</div>

<div class="container-fluid mt-2">

    <div class="row">

        <div class="col-md-9">
            <!-- Video already here -->
        </div>

        <div class="col-md-3">

            <div class="card">

                <div class="card-header">
                    Live Chat
                </div>

                <div class="card-body"
                     id="chat-box"
                     style="height:300px; overflow-y:auto;">
                </div>

                <div class="card-footer">

                    <input type="text"
                           id="chat-input"
                           class="form-control"
                           placeholder="Type message...">

                    <button onclick="sendMessage()"
                            class="btn btn-primary mt-2 w-100">
                        Send
                    </button>

                </div>

            </div>

        </div>

    </div>

</div>

<script src="https://meet.jit.si/external_api.js"></script>

<script>

const domain = "meet.jit.si";

const options = {

roomName: "{{ meeting_name }}",

width: "100%",
height: "100%",

parentNode: document.querySelector('#jitsi-container'),

userInfo: {

displayName: "{{ request.user.username }}"

},

configOverwrite: {

startWithAudioMuted: false,

startWithVideoMuted: false,

enableWelcomePage: false,

enableClosePage: false,

prejoinPageEnabled: true

},

interfaceConfigOverwrite: {

SHOW_JITSI_WATERMARK: false,

SHOW_BRAND_WATERMARK: false,

TOOLBAR_BUTTONS: [

'microphone',

'camera',

'closedcaptions',

'desktop',

'fullscreen',

'fodeviceselection',

'hangup',

'chat',

'recording',

'raisehand',

'tileview',

'select-background'

]

}

};

const api = new JitsiMeetExternalAPI(domain, options);

</script>


<script>

const sessionId = "{{ session.id }}";

const socket = new WebSocket(
    "ws://" + window.location.host + "/ws/classroom/" + sessionId + "/"
);

socket.onmessage = function(e) {

    const data = JSON.parse(e.data);

    const chatBox = document.getElementById("chat-box");

    chatBox.innerHTML +=
        "<div><b>" +
        data.username +
        ":</b> " +
        data.message +
        "</div>";

    chatBox.scrollTop = chatBox.scrollHeight;
};


function sendMessage() {

    const input = document.getElementById("chat-input");

    socket.send(JSON.stringify({

        message: input.value,
        username: "{{ request.user.username }}"

    }));

    input.value = "";
}

</script>
{% endblock %}