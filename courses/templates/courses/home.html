{% extends "courses/base.html" %}

{% block content %}

<h2>Dashboard</h2>

{% if dashboard_data %}
    {% for course in dashboard_data %}
        <div class="card">
            <h3>{{ course.title }}</h3>

            {% for cls in course.sessions %}
                <div class="card">
                    <strong>{{ cls.title }}</strong><br>
                    {% if request.user.is_staff %}
                        <a class="button"
                        href="{% url 'course_attendance' course.id %}">
                            View Attendance
                        </a>
                        <br><br>
                    {% endif %}
                    Date: {{ cls.scheduled_date }}<br>
                    Time: {{ cls.start_time }} - {{ cls.end_time }}<br><br>

                    {% if request.user.is_staff %}

                    {% if cls.status == "live" %}
                        <span style="color: green;"><strong>LIVE NOW</strong></span><br><br>

                        <button class="button"
                            onclick="toggleSession({{ cls.id }}, 'end')">
                            End Class
                        </button>

                    {% elif cls.status == "waiting" %}
                        <span style="color: blue;"><strong>Waiting for Teacher</strong></span><br><br>

                        <button class="button"
                            onclick="toggleSession({{ cls.id }}, 'start')">
                            Start Class
                        </button>

                    {% elif cls.status == "upcoming" %}
                        <span style="color: orange;"><strong>Upcoming</strong></span>

                    {% else %}
                        <span style="color: red;"><strong>Ended</strong></span>
                    {% endif %}

                    {% else %}

                    {% if cls.status == "live" %}
                        <span style="color: green;"><strong>LIVE NOW</strong></span><br><br>
                        <a class="button"
                         href="{% url 'live_class' cls.id %}">
                            Join Live Class
                        </a>

                    {% elif cls.status == "waiting" %}
                        <span style="color: blue;"><strong>Waiting for Teacher</strong></span>

                    {% elif cls.status == "upcoming" %}
                        <span style="color: orange;"><strong>Upcoming</strong></span>

                    {% else %}
                        <span style="color: red;"><strong>Ended</strong></span>
                    {% endif %}

                {% endif %}

                </div>
            {% empty %}
                <p>No sessions available.</p>
            {% endfor %}

        </div>
    {% endfor %}
{% else %}
    <p>No enrolled courses.</p>
{% endif %}

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleSession(sessionId, action) {

    let confirmMessage = action === 'start'
        ? "Are you sure you want to START this class?"
        : "Are you sure you want to END this class?";

    if (!confirm(confirmMessage)) {
        return;
    }
    
    const csrftoken = getCookie('csrftoken');

    fetch(`/toggle-session/${sessionId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": csrftoken,
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `action=${action}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert("Error occurred.");
        }
    });
}
</script>

{% endblock %}





