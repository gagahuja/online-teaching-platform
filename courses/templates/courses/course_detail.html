{% extends "courses/base.html" %}
{% block content %}

<div class="container mt-4">

    <h2>{{ course.title }}</h2>
    <hr>

    <!-- Progress -->
    <div class="progress-bar bg-success"
        role="progressbar"
        data-progress="{{ progress_percent }}">
        {{ progress_percent }}%
    </div>

    {% if progress_percent == 100 %}
        <a href="{% url 'download_certificate' course.id %}"
        class="btn btn-success mt-3">
        Download Certificate
        </a>
    {% endif %}
    <!-- Modules -->
    <h4>ðŸ“˜ Modules</h4>

    {% if modules %}
        <ul>

{% for module in modules %}

<li>

{% if module.locked %}

ðŸ”’ {{ module.order }}. {{ module.title }}

{% else %}

<input type="checkbox"
       class="module-checkbox"
       data-url="{% url 'toggle_module_completion' module.id %}"
       data-order="{{ module.order }}"
       {% if module.completed %}checked{% endif %}>

{{ module.order }}. {{ module.title }}

{% endif %}

</li>

{% endfor %}

</ul>
    {% else %}
        <p>No modules added.</p>
    {% endif %}

    <!-- Sessions -->
    <h4>ðŸŽ¥ Sessions</h4>

    {% if sessions %}
        <ul class="list-group">
            {% for session in sessions %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        {{ session.title }} â€”
                        {{ session.scheduled_date }}
                        {{ session.start_time }}
                    </span>

                    {% if session.is_active %}
                        <a href="{% url 'live_class' session.id %}"
                           class="btn btn-success btn-sm">
                            Join Live
                        </a>
                    {% else %}
                        <span class="badge bg-secondary">Not Live</span>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No sessions scheduled.</p>
    {% endif %}

</div>


<script>

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.querySelectorAll(".module-checkbox").forEach(cb => {

    cb.addEventListener("change", function() {

        const url = this.dataset.url;
        const currentOrder = parseInt(this.dataset.order);

        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "Content-Type": "application/json"
            }
        })
        .then(res => res.json())
        .then(data => {

            if(data.success){

                // unlock next module instantly
                document.querySelectorAll(".module-checkbox").forEach(nextCb => {

                    const order = parseInt(nextCb.dataset.order);

                    if(order === currentOrder + 1){
                        nextCb.disabled = false;

                        const lockIcon = nextCb.closest("li").querySelector(".lock-icon");
                        if(lockIcon){
                            lockIcon.remove();
                        }
                    }
                });

                location.reload();
            }

        });

    });

});

</script>

{% endblock %}