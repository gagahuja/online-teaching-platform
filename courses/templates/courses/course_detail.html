{% extends "courses/base.html" %}
{% block content %}

<div class="container mt-4">

    <h2>{{ course.title }}</h2>
    <hr>

    <!-- Progress -->
    <div class="progress-bar bg-success"
        role="progressbar"
        data-progress="{{ progress_percent }}">
        {{ progress_percent }}%
    </div>

    <!-- Modules -->
    <h4>ðŸ“˜ Modules</h4>

    {% if modules %}
        <ul>

{% for module in modules %}

<li>

{% if module.locked %}

ðŸ”’ {{ module.order }}. {{ module.title }}

{% else %}

<input type="checkbox"
       class="module-checkbox"
       data-url="{% url 'toggle_module_completion' module.id %}"
       {% if module.completed %}checked{% endif %}>

{{ module.order }}. {{ module.title }}

{% endif %}

</li>

{% endfor %}

</ul>
    {% else %}
        <p>No modules added.</p>
    {% endif %}

    <!-- Sessions -->
    <h4>ðŸŽ¥ Sessions</h4>

    {% if sessions %}
        <ul class="list-group">
            {% for session in sessions %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        {{ session.title }} â€”
                        {{ session.scheduled_date }}
                        {{ session.start_time }}
                    </span>

                    {% if session.is_active %}
                        <a href="{% url 'live_class' session.id %}"
                           class="btn btn-success btn-sm">
                            Join Live
                        </a>
                    {% else %}
                        <span class="badge bg-secondary">Not Live</span>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No sessions scheduled.</p>
    {% endif %}

</div>


<script>
function getCSRFToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === ('csrftoken=')) {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", function() {

    const checkboxes = document.querySelectorAll(".module-checkbox");

    checkboxes.forEach(function(box) {
        box.addEventListener("change", function() {

            const url = this.dataset.url;

                fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                }
            })
            .then(response => response.json())
            .then(data => {

                const progressBar = document.querySelector(".progress-bar");

                progressBar.style.width = data.progress_percent + "%";
                progressBar.innerText = data.progress_percent + "%";

            });
        });
    });

});
</script>

{% endblock %}